# app.py
from flask import Flask, render_template, request, redirect, url_for, flash
from flask_wtf import FlaskForm
from flask_sqlalchemy import SQLAlchemy
from wtforms import StringField, SubmitField, TextAreaField
from wtforms.validators import DataRequired, Email, Length
from datetime import datetime
import os

# Инициализация Flask и SQLAlchemy
app = Flask(__name__)
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-secret-key-123')

# Конфигурация базы данных (SQLite для разработки)
basedir = os.path.abspath(os.path.dirname(__file__))
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(basedir, 'app.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# Инициализация базы данных
db = SQLAlchemy(app)

# Модель для хранения сообщений из формы
class ContactMessage(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(100), nullable=False)
    message = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    is_read = db.Column(db.Boolean, default=False)

    def __repr__(self):
        return f'<ContactMessage {self.name}>'

# Модель для пользователей (пример расширения)
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    
    def __repr__(self):
        return f'<User {self.username}>'

# Определение формы
class ContactForm(FlaskForm):
    name = StringField('Ваше имя', validators=[
        DataRequired(message="Поле обязательно для заполнения"),
        Length(min=2, max=100, message="Имя должно быть от 2 до 100 символов")
    ])
    email = StringField('Email', validators=[
        DataRequired(message="Поле обязательно для заполнения"),
        Email(message="Введите корректный email адрес")
    ])
    message = TextAreaField('Сообщение', validators=[
        DataRequired(message="Поле обязательно для заполнения"),
        Length(min=10, max=500, message="Сообщение должно быть от 10 до 500 символов")
    ])
    submit = SubmitField('Отправить')

# Создание таблиц базы данных
with app.app_context():
    db.create_all()

# Главная страница
@app.route('/')
def index():
    # Пример статистики для главной страницы
    total_messages = ContactMessage.query.count()
    return render_template('index.html', total_messages=total_messages)

# Страница с формой
@app.route('/contact', methods=['GET', 'POST'])
def contact():
    form = ContactForm()
    
    if form.validate_on_submit():
        # Создание нового сообщения в базе данных
        new_message = ContactMessage(
            name=form.name.data,
            email=form.email.data,
            message=form.message.data
        )
        
        try:
            db.session.add(new_message)
            db.session.commit()
            flash(f'Спасибо, {form.name.data}! Ваше сообщение сохранено под номером #{new_message.id}.', 'success')
            return redirect(url_for('contact'))
        except Exception as e:
            db.session.rollback()
            flash('Произошла ошибка при сохранении сообщения. Попробуйте еще раз.', 'danger')
            app.logger.error(f'Error saving message: {str(e)}')
    
    return render_template('contact.html', form=form)

# Страница "О нас"
@app.route('/about')
def about():
    return render_template('about.html')

# Страница для просмотра всех сообщений (обычно защищается аутентификацией)
@app.route('/messages')
def view_messages():
    page = request.args.get('page', 1, type=int)
    per_page = 10
    
    messages = ContactMessage.query.order_by(ContactMessage.created_at.desc()).paginate(
        page=page, per_page=per_page, error_out=False
    )
    
    return render_template('messages.html', messages=messages)

# Страница для просмотра конкретного сообщения
@app.route('/message/<int:message_id>')
def view_message(message_id):
    message = ContactMessage.query.get_or_404(message_id)
    
    # Помечаем как прочитанное
    if not message.is_read:
        message.is_read = True
        db.session.commit()
    
    return render_template('message_detail.html', message=message)

# API endpoint для удаления сообщения (пример REST API)
@app.route('/api/message/<int:message_id>/delete', methods=['POST'])
def delete_message(message_id):
    message = ContactMessage.query.get_or_404(message_id)
    
    try:
        db.session.delete(message)
        db.session.commit()
        flash('Сообщение успешно удалено', 'success')
    except Exception as e:
        db.session.rollback()
        flash('Ошибка при удалении сообщения', 'danger')
        app.logger.error(f'Error deleting message: {str(e)}')
    
    return redirect(url_for('view_messages'))

# Команда для инициализации базы данных (можно использовать через Flask CLI)
@app.cli.command('init-db')
def init_db_command():
    """Инициализирует базу данных."""
    db.create_all()
    print('База данных инициализирована.')

@app.cli.command('seed-db')
def seed_db_command():
    """Заполняет базу данных тестовыми данными."""
    from datetime import datetime, timedelta
    
    # Создаем несколько тестовых сообщений
    test_messages = [
        ContactMessage(
            name='Иван Иванов',
            email='ivan@example.com',
            message='Это тестовое сообщение для проверки работы приложения.',
            created_at=datetime.utcnow() - timedelta(days=3),
            is_read=True
        ),
        ContactMessage(
            name='Мария Петрова',
            email='maria@example.com',
            message='Вопрос по поводу работы формы обратной связи.',
            created_at=datetime.utcnow() - timedelta(days=1),
            is_read=False
        ),
        ContactMessage(
            name='Алексей Смирнов',
            email='alex@example.com',
            message='Спасибо за отличное приложение! Очень удобно.',
            created_at=datetime.utcnow() - timedelta(hours=5),
            is_read=True
        ),
    ]
    
    for msg in test_messages:
        db.session.add(msg)
    
    db.session.commit()
    print('Тестовые данные добавлены в базу данных.')

if __name__ == '__main__':
    app.run(debug=True)

{% extends "base.html" %}

{% block title %}Главная страница{% endblock %}

{% block content %}
<h1>Добро пожаловать в мое Flask-приложение!</h1>
<p>Это базовая структура Flask-приложения с формой и базой данных.</p>

<div class="stats">
    <h3>Статистика:</h3>
    <p>Всего сообщений в базе: <strong>{{ total_messages }}</strong></p>
</div>

<div class="actions">
    <a href="{{ url_for('contact') }}" class="btn btn-primary">Отправить сообщение</a>
    <a href="{{ url_for('view_messages') }}" class="btn btn-secondary">Просмотреть все сообщения</a>
</div>

<div class="features">
    <h3>Возможности приложения:</h3>
    <ul>
        <li>Форма обратной связи с валидацией</li>
        <li>Хранение данных в SQLite базе данных</li>
        <li>Просмотр и управление сообщениями</li>
        <li>Пагинация списка сообщений</li>
        <li>Адаптивный дизайн</li>
    </ul>
</div>
{% endblock %}

{% extends "base.html" %}

{% block title %}Все сообщения{% endblock %}

{% block content %}
<h1>Список сообщений</h1>

{% if messages.items %}
    <div class="table-responsive">
        <table class="messages-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя</th>
                    <th>Email</th>
                    <th>Дата</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for message in messages.items %}
                <tr class="{% if not message.is_read %}unread{% endif %}">
                    <td>{{ message.id }}</td>
                    <td>{{ message.name }}</td>
                    <td>{{ message.email }}</td>
                    <td>{{ message.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>
                        {% if message.is_read %}
                            <span class="badge read">Прочитано</span>
                        {% else %}
                            <span class="badge unread">Новое</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('view_message', message_id=message.id) }}" class="btn btn-sm btn-info">Просмотреть</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Пагинация -->
    <div class="pagination">
        {% if messages.has_prev %}
            <a href="{{ url_for('view_messages', page=messages.prev_num) }}" class="btn">Назад</a>
        {% endif %}
        
        <span class="current-page">Страница {{ messages.page }} из {{ messages.pages }}</span>
        
        {% if messages.has_next %}
            <a href="{{ url_for('view_messages', page=messages.next_num) }}" class="btn">Вперед</a>
        {% endif %}
    </div>
{% else %}
    <div class="empty-state">
        <p>Сообщений пока нет.</p>
        <a href="{{ url_for('contact') }}" class="btn btn-primary">Создать первое сообщение</a>
    </div>
{% endif %}
{% endblock %}

{% extends "base.html" %}

{% block title %}Сообщение #{{ message.id }}{% endblock %}

{% block content %}
<div class="message-detail">
    <h1>Сообщение #{{ message.id }}</h1>
    
    <div class="message-header">
        <div class="message-meta">
            <p><strong>От:</strong> {{ message.name }}</p>
            <p><strong>Email:</strong> {{ message.email }}</p>
            <p><strong>Дата:</strong> {{ message.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
            <p><strong>Статус:</strong> 
                {% if message.is_read %}
                    <span class="badge read">Прочитано</span>
                {% else %}
                    <span class="badge unread">Новое</span>
                {% endif %}
            </p>
        </div>
    </div>
    
    <div class="message-content">
        <h3>Сообщение:</h3>
        <div class="message-text">
            {{ message.message|nl2br }}
        </div>
    </div>
    
    <div class="message-actions">
        <a href="{{ url_for('view_messages') }}" class="btn btn-secondary">Назад к списку</a>
        
        <form action="{{ url_for('delete_message', message_id=message.id) }}" method="POST" 
              onsubmit="return confirm('Вы уверены, что хотите удалить это сообщение?');" 
              style="display: inline;">
            <button type="submit" class="btn btn-danger">Удалить</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Подтверждение удаления
    document.addEventListener('DOMContentLoaded', function() {
        const deleteForms = document.querySelectorAll('form[onsubmit]');
        deleteForms.forEach(form => {
            form.onsubmit = function() {
                return confirm('Вы уверены, что хотите удалить это сообщение?');
            };
        });
    });
</script>
{% endblock %}

/* Основные стили */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f8f9fa;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Навигация */
nav {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

nav a {
    color: white;
    text-decoration: none;
    margin-right: 1.5rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    transition: background-color 0.3s;
}

nav a:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

/* Контейнер */
.container {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

/* Кнопки */
.btn {
    display: inline-block;
    padding: 0.7rem 1.5rem;
    text-decoration: none;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s ease;
    margin: 0.3rem;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
    padding: 0.3rem 0.8rem;
    font-size: 0.9rem;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Формы */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #495057;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Сообщения */
.flash {
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 5px;
    border: 1px solid transparent;
}

.flash.success {
    background-color: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
}

.flash.danger {
    background-color: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
}

.flash.info {
    background-color: #d1ecf1;
    color: #0c5460;
    border-color: #bee5eb;
}

/* Таблица сообщений */
.table-responsive {
    overflow-x: auto;
    margin: 1.5rem 0;
}

.messages-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 5px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
}

.messages-table thead {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
}

.messages-table th,
.messages-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.messages-table tbody tr:hover {
    background-color: #f8f9fa;
}

.messages-table tbody tr.unread {
    background-color: #e8f4fd;
    font-weight: 500;
}

/* Бейджи */
.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 50px;
    text-transform: uppercase;
}

.badge.read {
    background-color: #28a745;
    color: white;
}

.badge.unread {
    background-color: #ffc107;
    color: #212529;
}

/* Пагинация */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
}

.current-page {
    font-weight: 500;
    color: #495057;
}

/* Детали сообщения */
.message-detail {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.message-header {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    border-left: 4px solid #007bff;
}

.message-meta p {
    margin-bottom: 0.5rem;
}

.message-content {
    margin: 2rem 0;
}

.message-text {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    line-height: 1.8;
    white-space: pre-wrap;
    border-left: 4px solid #28a745;
}

.message-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
}

/* Пустое состояние */
.empty-state {
    text-align: center;
    padding: 3rem;
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #dee2e6;
}

.empty-state p {
    margin-bottom: 1.5rem;
    color: #6c757d;
    font-size: 1.1rem;
}

/* Статистика и фичи */
.stats, .features {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1.5rem 0;
    border-left: 4px solid #6a11cb;
}

.stats h3, .features h3 {
    margin-bottom: 1rem;
    color: #495057;
}

.features ul {
    padding-left: 1.5rem;
}

.features li {
    margin-bottom: 0.5rem;
}

.actions {
    display: flex;
    gap: 1rem;
    margin: 2rem 0;
}

/* Адаптивность */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    nav {
        padding: 0.5rem;
    }
    
    nav a {
        display: block;
        margin: 0.5rem 0;
        text-align: center;
    }
    
    .container {
        padding: 1rem;
    }
    
    .actions {
        flex-direction: column;
    }
    
    .message-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        margin: 0.3rem 0;
    }
}

Flask>=2.3.0
Flask-WTF>=1.1.0
Flask-SQLAlchemy>=3.0.0
WTForms>=3.0.0
python-dotenv>=1.0.0

SECRET_KEY=your-secret-key-here-change-in-production
FLASK_APP=app.py
FLASK_ENV=development
DATABASE_URL=sqlite:///app.db

my_flask_app/
├── app.py
├── app.db (создастся автоматически)
├── requirements.txt
├── .env
├── static/
│   └── style.css
└── templates/
    ├── base.html
    ├── index.html
    ├── contact.html
    ├── about.html
    ├── messages.html
    └── message_detail.html

# Установка зависимостей
pip install -r requirements.txt

# Инициализация базы данных
flask init-db

# Добавление тестовых данных
flask seed-db

# Запуск приложения
flask run
